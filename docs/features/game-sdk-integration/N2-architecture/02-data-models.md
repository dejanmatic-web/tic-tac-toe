# ğŸ“Š Data Models & State Management

---

## ğŸ—ƒï¸ Server State

### Room State (New Structure)

```typescript
interface SDKRoom {
  matchId: string;                    // From URL, generated by platform

  // Game state
  board: Board;
  currentPlayer: Player;
  winner: Winner;
  winningLine: number[] | null;
  turnStartedAt: number | null;
  disconnectReason: 'timeout' | 'disconnect' | null;
  gameStatus: 'waiting' | 'playing' | 'finished';

  // Player tracking (NEW)
  players: {
    X: AuthenticatedPlayer | null;
    O: AuthenticatedPlayer | null;
  };

  // Timers
  turnTimer: NodeJS.Timeout | null;

  // SDK tracking (NEW)
  sdkState: SDKState;
}
```

### Authenticated Player

```typescript
interface AuthenticatedPlayer {
  // From SDK validatePlayerToken
  id: number;                   // GamerStake user ID
  username: string;             // GamerStake username

  // Socket tracking
  socketId: string;             // Current socket.id
  token: string;                // Original JWT

  // Game state
  symbol: 'X' | 'O';            // Assigned symbol
  joinedAt: number;             // Timestamp
}
```

### SDK State Tracking

```typescript
interface SDKState {
  matchStarted: boolean;        // reportMatchStart called
  matchEnded: boolean;          // reportMatchResult/Error called
  playersReported: Set<number>; // reportPlayerJoin called for these IDs
}
```

### Socket Tracking

```typescript
// Mapping socket.id â†’ player info
interface SocketData {
  matchId: string;
  playerId: number;
  symbol: 'X' | 'O';
}

const socketToPlayer = new Map<string, SocketData>();
```

---

## ğŸ“¤ Client State

### Frontend State Model

```typescript
interface GameClientState {
  // URL params
  matchId: string;
  token: string | null;

  // Connection state
  connectionStatus: 'connecting' | 'connected' | 'error';
  connectionError: string | null;

  // Player info (from server)
  myPlayer: PlayerInfo | null;

  // Room state (from server)
  roomState: RoomState | null;

  // UI state
  remainingTime: number | null;
  showResult: boolean;
}

interface PlayerInfo {
  id: number;
  username: string;
  symbol: 'X' | 'O';
}
```

---

## ğŸ”„ State Transitions

### Room Lifecycle

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ CREATED  â”‚ â—„â”€â”€â”€ First player joins
                    â”‚ (waiting)â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                         â”‚ Second player joins
                         â”‚ + reportMatchStart
                         â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ PLAYING  â”‚ â—„â”€â”€â”€ Game in progress
                    â”‚          â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                         â”‚
                    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
                    â”‚         â”‚
                    â–¼         â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚FINISHEDâ”‚  â”‚ ERROR  â”‚
               â”‚(winner)â”‚  â”‚(abort) â”‚
               â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                    â”‚           â”‚
                    â–¼           â–¼
               reportMatchResult  reportMatchError
```

### Player Connection States

```
PLATFORM                         GAME
    â”‚                                â”‚
    â”‚ Redirect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
    â”‚                                â”‚
    â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚                         â”‚ CONNECTING  â”‚
    â”‚                         â”‚ joinMatch() â”‚
    â”‚                         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                â”‚
    â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚                         â”‚ VALIDATING  â”‚
    â”‚                         â”‚ SDK check   â”‚
    â”‚                         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                â”‚
    â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    â”‚                       â”‚
    â”‚             â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚  JOINED     â”‚         â”‚   ERROR     â”‚
    â”‚             â”‚  matchJoinedâ”‚         â”‚  matchError â”‚
    â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ Data Mapping

### Winner â†’ SDK MatchResult

```typescript
function toSDKMatchResult(room: SDKRoom, winner: Winner): MatchResult {
  const playerX = room.players.X!;
  const playerO = room.players.O!;

  if (winner === 'draw') {
    return {
      players: [
        { id: playerX.id, score: 0, isWinner: false },
        { id: playerO.id, score: 0, isWinner: false },
      ],
    };
  }

  const winnerPlayer = winner === 'X' ? playerX : playerO;
  const loserPlayer = winner === 'X' ? playerO : playerX;

  return {
    players: [
      { id: winnerPlayer.id, score: 1, isWinner: true },
      { id: loserPlayer.id, score: 0, isWinner: false },
    ],
  };
}
```

### Room â†’ Client RoomState

```typescript
function toClientState(room: SDKRoom): RoomState {
  return {
    matchId: room.matchId,
    board: room.board,
    currentPlayer: room.currentPlayer,
    players: {
      X: room.players.X?.username ?? null,
      O: room.players.O?.username ?? null,
    },
    winner: room.winner,
    winningLine: room.winningLine,
    turnStartedAt: room.turnStartedAt,
    disconnectReason: room.disconnectReason,
    gameStatus: room.gameStatus,
  };
}
```

---

## ğŸ” Validation Rules

```typescript
// Token format (JWT)
const TOKEN_REGEX = /^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/;

// Match ID (from platform)
const MATCH_ID_REGEX = /^[a-zA-Z0-9_-]{1,100}$/;

function isValidToken(token: string): boolean {
  return TOKEN_REGEX.test(token);
}

function isValidMatchId(matchId: string): boolean {
  return MATCH_ID_REGEX.test(matchId);
}
```

---

## ğŸ“ Next Step

See â†’ `N3-implementation/01-iteration-plan.md` for implementation plan.
